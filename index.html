<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EduPulse ‚Äî Modern ERP (KL-style)</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* ============================
       THEME & GLOBAL (KL-like)
       ============================ */
    :root{
      --bg: #f4f6f9;
      --panel: #ffffff;
      --muted: #6b7280;
      --text: #0f1724;
      --primary: #0b5ed7; /* more corporate blue */
      --accent: linear-gradient(90deg,#0b5ed7,#06b6d4);
      --shadow: 0 8px 28px rgba(13,20,30,0.06);
      --glass: rgba(255,255,255,0.6);
      --danger: linear-gradient(90deg,#ef4444,#f97316);
      --success: #047857;
      --sidebar-width: 260px;
      --sidebar-collapsed: 72px;
      --radius: 10px;
    }

    /* THEME VARIABLES FOR DYNAMIC CHANGE */
    .theme-green {
      --primary: #047857; /* Emerald green */
      --accent: linear-gradient(90deg,#047857,#10b981);
    }
    .theme-red {
      --primary: #b91c1c; /* Strong Red */
      --accent: linear-gradient(90deg,#b91c1c,#f87171);
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,Arial;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    a{color:inherit}

    /* helper */
    .hidden{display:none !important}

    /* centered auth shell (login/signup) */
    #auth-shell{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:28px;
    }
    .auth-card{
      width:980px;
      max-width:100%;
      display:grid;
      grid-template-columns:420px 1fr;
      gap:20px;
      background:var(--panel);
      box-shadow:var(--shadow);
      border-radius:14px;
      overflow:hidden;
    }
    .auth-left{
      padding:28px;
      background:linear-gradient(180deg,#ffffff,#f7fbff);
    }
    .auth-right{
      padding:28px;
    }
    .brand{
      display:flex;gap:12px;align-items:center;margin-bottom:18px;
    }
    .logo{
      width:56px;height:56px;border-radius:12px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:20px;box-shadow:0 6px 18px rgba(11,17,32,0.06)
    }
    h1,h2,h3{margin:0;padding:0}
    .muted{color:var(--muted);font-size:14px}
    .small{font-size:13px;color:var(--muted)}

    label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
    input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(15,23,36,0.06);background:transparent;font-size:14px}
    .auth-actions{display:flex;gap:10px;margin-top:12px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:0;cursor:pointer;background:var(--primary);color:#fff;font-weight:700;box-shadow:0 8px 22px rgba(11,93,215,0.12); transition: all 0.2s ease;}
    .btn:hover {opacity: 0.9;}
    .btn-outline{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--text);font-weight:700;padding:10px 14px;border-radius:10px}
    .link-btn{border:0;background:none;color:var(--primary);cursor:pointer;padding:4px;font-weight:700}

    /* layout for app (post-login) */
    #app-shell{height:100vh;display:flex;overflow:hidden}
    .sidebar{
      width:var(--sidebar-width);
      background:#ffffff;
      border-right:1px solid rgba(15,23,36,0.04);
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:14px;
      transition:width .18s ease, transform .18s ease;
      box-shadow:var(--shadow);
    }
    .sidebar.collapsed{width:var(--sidebar-collapsed)}
    .sidebar .brand-small{display:flex;gap:12px;align-items:center}
    .sidebar .title {font-weight:700;font-size:16px}
    .sidebar .muted{font-size:13px;color:var(--muted)}
    .sidebar .menu{display:flex;flex-direction:column;gap:6px;margin-top:6px}
    .menu-item{
      display:flex;align-items:center;gap:12px;padding:10px;border-radius:8px;cursor:pointer;color:var(--text);font-weight:700;
    }
    .menu-item:hover{background:rgba(11,93,215,0.05)}
    .menu-item.active{background:var(--primary);color:#fff;box-shadow:0 6px 18px rgba(11,93,215,0.12)}
    .menu-item .icon{width:28px;height:28;display:inline-flex;align-items:center;justify-content:center}
    .sidebar .foot{margin-top:auto;font-size:13px;color:var(--muted);text-align:center;padding-top:8px}

    .main{flex:1;padding:22px;overflow:auto}
    header.app-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;gap:12px}
    .chip{padding:8px 12px;border-radius:999px;background:rgba(0,0,0,0.04);font-weight:700;color:var(--muted)}
    .row{display:flex;gap:12px;align-items:center}
    .card{background:var(--panel);padding:16px;border-radius:12px;box-shadow:var(--shadow);margin-bottom:12px}
    .two-col{display:grid;grid-template-columns:1fr 360px;gap:14px}
    @media (max-width:1000px){.two-col{grid-template-columns:1fr}}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(15,23,36,0.04);text-align:left}
    .small-muted{color:var(--muted);font-size:13px}

    .form-row{display:flex;gap:10px}
    .form-row > *{flex:1}
    .danger{background:var(--danger);color:white}
    
    /* CAPTCHA-specific styles (retained) */
    .captcha-box {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
    }
    .captcha-challenge {
        padding: 8px 12px;
        background: #f0f4f8;
        border-radius: 6px;
        font-weight: 700;
        color: var(--text);
        font-size: 16px;
        min-width: 120px;
        text-align: center;
        border: 1px solid rgba(15, 23, 36, 0.08);
    }
    .captcha-input {
        flex: 1;
        max-width: 100px;
    }

    /* Dropdown menu styling for nested pages (Hostel/Fees) */
    .nested-page-menu {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 15px;
      padding-left: 10px;
      border-left: 3px solid rgba(0,0,0,0.05);
    }
    .nested-menu-item {
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      background: var(--panel);
      border: 1px solid rgba(15,23,36,0.08);
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .nested-menu-item:hover {
      background: rgba(11,93,215,0.05);
      border-color: var(--primary);
    }
    .nested-menu-item.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
      box-shadow: 0 4px 10px rgba(11,93,215,0.2);
    }

    /* Admin Action Styles */
    .action-badge {
        font-size: 11px;
        font-weight: 700;
        padding: 4px 8px;
        border-radius: 6px;
        margin-left: 10px;
        color: white;
        background: #f97316; /* Orange for pending/open */
    }
    .status-Pending { background: #f97316; }
    .status-Open { background: #f97316; }
    .status-Approved { background: var(--success); }
    .status-Paid { background: var(--primary); }
    .status-Closed { background: #4b5563; }
    .status-Rejected { background: #b91c1c; }


    /* subtle responsiveness */
    @media (max-width:780px){
      .auth-card{grid-template-columns:1fr; padding:10px}
      .sidebar{display:none}
    }
  </style>
</head>
<body class="theme-light"> <div id="auth-shell">
    <div class="auth-card" role="region" aria-label="auth">
      <div class="auth-left">
        <div class="brand">
          <div class="logo">EP</div>
          <div>
            <div style="font-weight:800;font-size:18px">EduPulse</div>
            <div class="small">Student Performance ERP - Demo</div>
          </div>
        </div>

        <div style="margin-top:18px;">
          <h2 style="font-size:20px;margin-bottom:6px">Sign in to your account</h2>
          <div class="small-muted">Enter credentials to access admin or student area. Use sample data or sign up if you're new.</div>

          <div style="margin-top:12px">
            <label for="login-role">Role</label>
            <select id="login-role" aria-label="role">
              <option value="student">Student</option>
              <option value="admin">Admin</option>
            </select>

            <label for="login-id" style="margin-top:10px">Roll / Username</label>
            <input id="login-id" placeholder="e.g. 101 or admin">

            <label for="login-pass" style="margin-top:10px">Password</label>
            <input id="login-pass" type="password" placeholder="password">

            <label style="margin-top:10px">Security Check (Simple Math)</label>
            <div class="captcha-box">
                <div id="captcha-challenge" class="captcha-challenge"></div>
                <input id="captcha-answer" class="captcha-input" placeholder="Answer" type="number" required>
            </div>
            <div class="auth-actions" style="margin-top:12px">
              <button class="btn" id="login-btn">Login</button>
              <button class="btn btn-outline" id="open-signup">Sign Up</button>
            </div>

            <div id="login-msg" class="small" style="margin-top:10px;color:#b91c1c"></div>
          </div>
        </div>

        <div style="margin-top:22px">
          <h3 style="margin-bottom:6px">Demo</h3>
          <div class="small-muted">Quickly try the app</div>
          <div style="display:flex;gap:8px;margin-top:8px;">
            <button class="btn" id="demo-load-sample">Load Sample Data</button>
            <button class="btn btn-outline" id="demo-clear-local">Clear Data</button>
          </div>
        </div>

        <div style="margin-top:20px" class="small-muted">Tip: Login as <b>admin / 123456</b> after loading sample data.</div>
      </div>

      <div class="auth-right">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h2 style="margin-bottom:4px">New? Create an account</h2>
            <div class="muted">Choose Admin or Student. Admins can manage class data.</div>
          </div>
          <div style="text-align:right">
            <button class="link-btn" id="go-home">Back to Home</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <div style="display:flex;gap:12px">
            <div style="flex:1;">
              <h3 style="margin-bottom:6px">Student Sign Up</h3>
              <label>Roll No (unique)</label>
              <input id="stu-su-roll" placeholder="e.g. 101">
              <label style="margin-top:8px">Full Name</label>
              <input id="stu-su-name" placeholder="Rohit Kumar">
              <label style="margin-top:8px">Class / Section</label>
              <input id="stu-su-class" placeholder="10-A">
              <label style="margin-top:8px">Password</label>
              <input id="stu-su-pass" type="password" placeholder="At least 6 chars">
              <div style="margin-top:10px">
                <button class="btn" id="stu-create-btn">Create Student</button>
                <button class="btn btn-outline" id="auth-back">Back</button>
              </div>
              <div id="stu-su-msg" class="small" style="margin-top:8px;color:#b91c1c"></div>
            </div>

            <div style="flex:1;">
              <h3 style="margin-bottom:6px">Admin Sign Up</h3>
              <label>Username</label>
              <input id="admin-su-username" placeholder="e.g. teacher1">
              <label style="margin-top:8px">Full Name</label>
              <input id="admin-su-name" placeholder="Sheila Patel">
              <label style="margin-top:8px">Password</label>
              <input id="admin-su-pass" type="password" placeholder="At least 6 chars">
              <div style="margin-top:10px">
                <button class="btn" id="admin-create-btn">Create Admin</button>
                <button class="btn btn-outline" id="auth-back2">Back</button>
              </div>
              <div id="admin-su-msg" class="small" style="margin-top:8px;color:#b91c1c"></div>
            </div>
          </div>

          <div style="margin-top:18px">
            <h4 style="margin-bottom:6px">About EduPulse</h4>
            <div class="small-muted">EduPulse is a frontend-only demo of a Student Performance ERP. It stores data in your browser. Good for hackathons & prototypes.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="app-shell" class="hidden">
    <div class="sidebar" id="sidebar" role="navigation" aria-label="Main menu">
      <div class="brand-small">
        <div class="logo" style="width:44px;height:44px;font-size:16px">EP</div>
        <div>
          <div class="title">EduPulse</div>
          <div class="muted">Student ERP (Demo)</div>
        </div>
        <div style="margin-left:auto">
          <button class="link-btn" id="sidebar-toggle" title="Toggle sidebar">‚ò∞</button>
        </div>
      </div>

      <div id="menu-admin" class="menu hidden" aria-hidden="true">
        <div class="menu-item active" data-page="page-admin"><div class="icon">üè†</div><div class="label">Dashboard</div></div>
        <div class="menu-item" data-page="page-admin-marks"><div class="icon">‚úèÔ∏è</div><div class="label">Update Marks</div></div>
        <div class="menu-item" data-page="page-admin-students"><div class="icon">üë•</div><div class="label">Students</div></div>
        <div class="menu-item" data-page="page-admin-courses"><div class="icon">üìö</div><div class="label">Courses</div></div>
        <div class="menu-item" data-page="page-admin-timetable"><div class="icon">üìÖ</div><div class="label">Timetable</div></div>
        <div class="menu-item" data-page="page-admin-attendance"><div class="icon">‚úÖ</div><div class="label">Attendance</div></div>
        <div class="menu-item" data-page="page-admin-att-report"><div class="icon">üì∞</div><div class="label">Attendance Report</div></div>
        <div class="menu-item" data-page="page-admin-hostel"><div class="icon">üõå</div><div class="label">Hostel Requests</div></div>
        <div class="menu-item" data-page="page-admin-fees"><div class="icon">üíµ</div><div class="label">Fees Management</div></div>
        <div class="menu-item" data-page="page-admin-reval"><div class="icon">üì®</div><div class="label">Reval Requests</div></div>
        <div class="menu-item" data-page="page-admin-profile"><div class="icon">üë§</div><div class="label">Profile</div></div>
        <div class="menu-item danger" id="admin-logout-btn"><div class="icon">‚§¥Ô∏è</div><div class="label">Logout</div></div>
      </div>

      <div id="menu-student" class="menu hidden" aria-hidden="true">
        <div class="menu-item active" data-page="page-student"><div class="icon">üè†</div><div class="label">Dashboard</div></div>
        <div class="menu-item" data-page="page-stu-marks"><div class="icon">üìä</div><div class="label">My Marks</div></div>
        <div class="menu-item" data-page="page-stu-attendance"><div class="icon">üìù</div><div class="label">Attendance</div></div>
        <div class="menu-item" data-page="page-stu-timetable"><div class="icon">üìÜ</div><div class="label">Timetable</div></div>
        
        <div class="menu-item" data-page="page-stu-fees-main"><div class="icon">üíµ</div><div class="label">Fees Management</div></div>
        <div class="menu-item" data-page="page-stu-hostel-main"><div class="icon">üõå</div><div class="label">Hostel & Outing</div></div>

        <div class="menu-item" data-page="page-stu-reval"><div class="icon">üì®</div><div class="label">Re-evaluation</div></div>
        <div class="menu-item" data-page="page-stu-profile"><div class="icon">üë§</div><div class="label">Profile</div></div>
        <div class="menu-item danger" id="stu-logout-btn"><div class="icon">‚§¥Ô∏è</div><div class="label">Logout</div></div>
      </div>

      <div class="foot">EduPulse ‚Ä¢ local demo</div>
    </div>

    <main class="main" id="main">
      <header class="app-header">
        <div style="display:flex;align-items:center;gap:12px">
          <div class="chip" id="current-role-chip">Guest</div>
          <div class="small-muted" id="current-user">Not signed in</div>
        </div>
        <div style="display:flex;align-items:center;gap:10px">
          <select id="theme-picker" style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)">
            <option value="light">Light</option>
            <option value="dark">Dark</option>
            <option value="blue">Blue</option>
            <option value="green">Green</option>
            <option value="red">Red</option>
          </select>
        </div>
      </header>

      <section id="page-admin" class="card hidden">
        <div class="two-col">
          <div>
            <h2>Admin Dashboard</h2>
            <div class="small-muted" id="admin-welcome">Signed in as ‚Äî</div>

            <div class="card" style="margin-top:12px">
              <h3>Quick Actions</h3>
              <div style="display:flex;gap:10px;margin-top:10px">
                <button class="btn" id="admin-action-add-stu">Add Student</button>
                <button class="btn" id="admin-action-fill-sample">Fill Sample Marks</button>
                <button class="btn btn-outline" id="admin-action-export">Export Class PDF</button>
              </div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Today's Timetable</h3>
              <div id="admin-today-timetable" class="small-muted">No timetable set.</div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Attendance Snapshot</h3>
              <div id="admin-att-snapshot" class="small-muted">No records yet.</div>
            </div>
          </div>

          <div>
            <div class="card">
              <h3>Class Analytics</h3>
              <div style="height:220px"><canvas id="class-bar"></canvas></div>
              <div class="small-muted" style="margin-top:8px">Subject-wise average marks across class.</div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Recently Added Students</h3>
              <div id="recent-students" class="small-muted">‚Äî</div>
            </div>
          </div>
        </div>
      </section>

      <section id="page-admin-marks" class="card hidden">
        <h2>Update Marks</h2>
        <div style="max-width:720px">
          <label>Select Student</label>
          <select id="sel-student"></select>
          <label>Subject</label>
          <select id="subj">
            <option>Mathematics</option>
            <option>Physics</option>
            <option>Chemistry</option>
            <option>English</option>
            <option>Computer</option>
          </select>
          <label>Marks (0 - 100)</label>
          <input id="marks" type="number" min="0" max="100" value="80">
          <div style="display:flex;gap:10px;margin-top:10px">
            <button class="btn" id="save-marks">Save Marks</button>
            <button class="btn btn-outline" id="admin-sample">Add Sample Marks</button>
          </div>
          <div id="marks-msg" class="small-muted" style="margin-top:10px"></div>
        </div>
      </section>

      <section id="page-admin-students" class="card hidden">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2>Students</h2>
          <div class="small-muted">Total: <span id="students-count">0</span></div>
        </div>
        
        <div class="card" style="margin-top:10px">
            <h3>Search & Filter</h3>
            <input id="student-search-input" placeholder="Search by Roll No or Name..." onkeyup="renderAdminTables()">
        </div>
        <div class="card" style="margin-top:10px">
          <h3>Add Student</h3>
          <label>Roll No (unique)</label><input id="s-roll" placeholder="e.g. 101">
          <label>Full Name</label><input id="s-name" placeholder="e.g. Rahul Sharma">
          <label>Class / Section</label><input id="s-class" placeholder="10-A">
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" id="add-student">Add Student</button>
            <button class="btn btn-outline" id="admin-sample-fill">Fill All with Sample</button>
          </div>
          <div id="student-msg" class="small-muted" style="margin-top:8px"></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Students Table</h3>
          <div style="overflow:auto;max-height:320px">
            <table id="students-table">
              <thead><tr><th>Roll</th><th>Name</th><th>Class</th><th>Avg</th><th>Actions</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="page-admin-courses" class="card hidden">
        <h2>Courses You Teach</h2>
        <div style="max-width:720px">
          <label>Course Code</label><input id="course-code" placeholder="e.g. MATH101">
          <label>Course Title</label><input id="course-title" placeholder="e.g. Mathematics">
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" id="add-course">Add Course</button>
            <button class="btn btn-outline" id="clear-courses">Clear Courses</button>
          </div>
          <div id="course-msg" class="small-muted" style="margin-top:8px"></div>

          <div class="card" style="margin-top:12px">
            <h3>Courses List</h3>
            <ul id="course-list" class="small-muted"></ul>
          </div>
        </div>
      </section>

      <section id="page-admin-timetable" class="card hidden">
        <h2>Timetable (Edit)</h2>
        <div style="max-width:720px">
          <label>Day</label>
          <select id="tt-day"><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option><option>Saturday</option></select>
          <label>Time Slot</label><input id="tt-slot" placeholder="10:00 - 11:00">
          <label>Subject / Activity</label><input id="tt-sub" placeholder="Mathematics">
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" id="add-tt">Add Slot</button>
            <button class="btn btn-outline" id="clear-tt">Clear Timetable</button>
          </div>
          <div id="tt-msg" class="small-muted" style="margin-top:8px"></div>

          <div class="card" style="margin-top:12px">
            <h3>Full Timetable</h3>
            <div id="tt-list" class="small-muted"></div>
          </div>
        </div>
      </section>

      <section id="page-admin-attendance" class="card hidden">
        <h2>Attendance</h2>
        <div style="max-width:720px">
          <label>Select Date</label><input id="att-date" type="date">
          <label>Select Class</label><input id="att-class" placeholder="10-A">
          <div style="margin-top:8px" id="att-students-list"></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" id="save-attendance">Save Attendance</button>
            <button class="btn btn-outline" id="view-attendance">View Attendance</button>
          </div>
          <div id="att-msg" class="small-muted" style="margin-top:8px"></div>
        </div>
      </section>
      
      <section id="page-admin-att-report" class="card hidden">
          <h2>Attendance Report</h2>
          <div style="max-width:720px">
              <div class="form-row">
                  <div style="flex:1;">
                      <label>Select Class (Optional)</label>
                      <input id="report-class" placeholder="e.g. 10-A">
                  </div>
                  <div style="flex:1;">
                      <label>Select Date (Optional)</label>
                      <input id="report-date" type="date">
                  </div>
              </div>
              <div style="margin-top:10px">
                  <button class="btn" id="generate-att-report">Generate Report</button>
                  <button class="btn btn-outline" id="clear-att-report">Clear Filters</button>
              </div>
              <div id="att-report-msg" class="small-muted" style="margin-top:8px"></div>
              <div class="card" style="margin-top:12px">
                  <h3>Report Results</h3>
                  <div id="att-report-results" style="overflow-x:auto">No report generated.</div>
              </div>
          </div>
      </section>
      <section id="page-admin-hostel" class="card hidden">
        <h2>Hostel & Issue Management</h2>
        <div class="card">
            <h3>Outing Requests (Pending)</h3>
            <div id="admin-outing-requests">No pending requests.</div>
        </div>
        <div class="card">
            <h3>Hostel Issues (Open)</h3>
            <div id="admin-issue-requests">No open issues.</div>
        </div>
      </section>

      <section id="page-admin-fees" class="card hidden">
        <h2>Fees Management</h2>
        <div class="card">
            <h3>Add New Fee Due</h3>
            <div style="max-width:720px">
                <label>Select Student</label><select id="admin-fee-stu"></select>
                <label>Fee Type</label><input id="admin-fee-type" value="Tuition">
                <label>Amount (‚Çπ)</label><input id="admin-fee-amount" type="number" value="15000">
                <label>Due Date</label><input id="admin-fee-due-date" type="date">
                <div style="margin-top:10px">
                    <button class="btn" id="admin-add-due">Add Fee Due</button>
                </div>
                <div id="admin-fee-msg" class="small-muted" style="margin-top:8px"></div>
            </div>
        </div>
        <div class="card">
            <h3>All Student Dues</h3>
            <div id="admin-all-dues">No pending dues.</div>
        </div>
      </section>

      <section id="page-admin-reval" class="card hidden">
        <h2>Re-evaluation Requests</h2>
        <div id="admin-reval-requests" class="card">No pending re-evaluation requests.</div>
        <div id="admin-reval-action" class="card hidden" style="margin-top:12px">
            <h3>Update Marks (After Approval)</h3>
            <label>Student Roll</label><input id="reval-update-roll" disabled>
            <label>Subject</label><input id="reval-update-subj" disabled>
            <label>New Mark</label><input id="reval-update-mark" type="number" min="0" max="100">
            <div style="margin-top:10px">
                <button class="btn" id="reval-final-save">Finalize Mark Update</button>
            </div>
            <div id="reval-update-msg" class="small-muted" style="margin-top:8px"></div>
        </div>
      </section>
      <section id="page-admin-profile" class="card hidden">
        <h2>Profile</h2>
        <div id="admin-profile-content" class="small-muted">‚Äî</div>
      </section>

      <section id="page-student" class="card hidden">
        <div class="two-col">
          <div>
            <h2>Student Dashboard</h2>
            <div id="stu-welcome" class="small-muted">‚Äî</div>

            <div class="card" style="margin-top:12px">
              <h3>Quick Links</h3>
              <div style="display:flex;gap:8px;margin-top:10px">
                <button class="btn" id="stu-download">Download Report</button>
                <button class="btn btn-outline" id="stu-apply-reval">Apply Re-evaluation</button>
              </div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Suggestions</h3>
              <div id="stu-suggestions" class="small-muted">‚Äî</div>
            </div>
          </div>

          <div>
            <div class="card">
              <h3>Subject Comparison</h3>
              <div style="height:220px"><canvas id="stu-bar"></canvas></div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Attendance Overview</h3>
              <div id="stu-att-overview" class="small-muted">‚Äî</div>
            </div>
          </div>
        </div>
      </section>

      <section id="page-stu-marks" class="card hidden">
        <h2>Your Marks</h2>
        <div class="card">
          <h3>Marks Table</h3>
          <table id="stu-table"><thead><tr><th>Subject</th><th>Marks</th></tr></thead><tbody></tbody></table>
        </div>
      </section>

      <section id="page-stu-attendance" class="card hidden">
        <h2>Your Attendance</h2>
        <div id="stu-att-list" class="card small-muted">No attendance recorded.</div>
      </section>

      <section id="page-stu-timetable" class="card hidden">
        <h2>Your Timetable</h2>
        <div id="stu-timetable-list" class="small-muted">No timetable set.</div>
      </section>

      <section id="page-stu-reval" class="card hidden">
        <h2>Apply for Re-evaluation</h2>
        <div style="max-width:720px">
          <label>Subject</label><select id="reval-sub"><option>Mathematics</option><option>Physics</option><option>Chemistry</option><option>English</option><option>Computer</option></select>
          <label>Reason</label><textarea id="reval-reason" rows="3"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" id="submit-reval">Submit Request</button>
          </div>
          <div id="reval-msg" class="small-muted" style="margin-top:8px"></div>

          <div class="card" style="margin-top:12px">
            <h3>Your Re-eval Requests</h3>
            <div id="reval-list" class="small-muted"></div>
          </div>
        </div>
      </section>

      <section id="page-stu-profile" class="card hidden">
        <h2>Your Profile</h2>
        <div id="stu-profile-content" class="small-muted">‚Äî</div>
      </section>

      <section id="page-stu-hostel-main" class="card hidden">
        <h2>Hostel Management</h2>
        <div class="nested-page-menu" id="hostel-menu">
          <div class="nested-menu-item active" data-nested-page="page-stu-hostel-outing">üö∂ Outing Request</div>
          <div class="nested-menu-item" data-nested-page="page-stu-hostel-issue">‚ö†Ô∏è Report Issue</div>
        </div>
        
        <div id="page-stu-hostel-outing" class="card" style="margin-top:15px">
          <h3>Outing Request</h3>
          <div style="max-width:500px">
            <label>Destination</label><input id="outing-dest" placeholder="e.g., Home or City Market">
            <label>Reason</label><textarea id="outing-reason" rows="2"></textarea>
            <label>Expected Return Date</label><input id="outing-return-date" type="date">
            <div style="margin-top:10px">
              <button class="btn" id="submit-outing">Submit Request</button>
            </div>
            <div id="outing-msg" class="small-muted" style="margin-top:8px"></div>
            <div class="card" style="margin-top:12px">
              <h4>My Outing Requests</h4>
              <div id="outing-list" class="small-muted">No requests found.</div>
            </div>
          </div>
        </div>
        
        <div id="page-stu-hostel-issue" class="card hidden" style="margin-top:15px">
          <h3>Report Hostel Issue</h3>
          <div style="max-width:500px">
            <label>Location (Room No / Common Area)</label><input id="issue-location" placeholder="e.g., Room 302 fan or Mess Hall light">
            <label>Issue Description</label><textarea id="issue-desc" rows="3"></textarea>
            <div style="margin-top:10px">
              <button class="btn" id="submit-issue">Submit Issue</button>
            </div>
            <div id="issue-msg" class="small-muted" style="margin-top:8px"></div>
            <div class="card" style="margin-top:12px">
              <h4>My Reported Issues</h4>
              <div id="issue-list" class="small-muted">No issues reported.</div>
            </div>
          </div>
        </div>
      </section>

      <section id="page-stu-fees-main" class="card hidden">
        <h2>Fees Management</h2>
        <div class="nested-page-menu" id="fees-menu">
          <div class="nested-menu-item active" data-nested-page="page-stu-fees-due">üí∞ View Fees Due</div>
          <div class="nested-menu-item" data-nested-page="page-stu-fees-pay">üí≥ Make Payment</div>
          <div class="nested-menu-item" data-nested-page="page-stu-fees-history">üìú Payment History & Receipt</div>
        </div>
        
        <div id="page-stu-fees-due" class="card" style="margin-top:15px">
          <h3>Fees Due Now</h3>
          <div id="fees-due-info" class="small-muted">
            <p><strong>Total Due:</strong> ‚Çπ <span id="fees-due-amount">0.00</span></p>
            <p><strong>Last Payment Due Date:</strong> <span id="fees-due-date">N/A</span></p>
            <button class="btn" style="margin-top:10px" id="fees-pay-quick">Go to Payment</button>
          </div>
        </div>

        <div id="page-stu-fees-pay" class="card hidden" style="margin-top:15px">
          <h3>Make Payment</h3>
          <div style="max-width:500px">
            <label>Fee Type</label><input value="Tuition Fee" disabled>
            <label>Amount (‚Çπ)</label><input id="fee-amount" type="number" value="15000" min="100">
            <label>Payment Method (Simulated)</label>
            <select id="fee-method"><option>Credit Card</option><option>UPI</option><option>Net Banking</option></select>
            <div style="margin-top:10px">
              <button class="btn" id="submit-fee-payment">Confirm Payment</button>
            </div>
            <div id="fees-pay-msg" class="small-muted" style="margin-top:8px"></div>
          </div>
        </div>

        <div id="page-stu-fees-history" class="card hidden" style="margin-top:15px">
          <h3>Payment History & Receipts</h3>
          <div style="overflow:auto">
            <table id="fees-history-table">
              <thead><tr><th>Date</th><th>Amount</th><th>Status</th><th>Receipt</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="small-muted" id="fees-history-none" style="margin-top:10px">No payments recorded.</div>
        </div>
      </section>

      <footer style="margin-top:18px;color:var(--muted);font-size:13px">EduPulse ‚Ä¢ Frontend demo ‚Ä¢ Data in browser (localStorage)</footer>

    </main>
  </div>

<script>
/* ===============================
   STORAGE KEYS & DB helpers
   =============================== */
const LS_KEY = "edupulse_v1";
const LS_SESSION = "edupulse_session";
let currentCaptchaAnswer = null;

function loadDB(){
  try{ return JSON.parse(localStorage.getItem(LS_KEY) || "{}"); }
  catch(e){ return {}; }
}
function saveDB(db){ localStorage.setItem(LS_KEY, JSON.stringify(db)); }

let DB = loadDB();
if(!DB.admins) DB.admins = {};
if(!DB.students) DB.students = {};
if(!DB.courses) DB.courses = {};
if(!DB.timetable) DB.timetable = {};
if(!DB.attendance) DB.attendance = {};
saveDB(DB);

function saveSession(session){ localStorage.setItem(LS_SESSION, JSON.stringify(session)); }
function loadSession(){ return JSON.parse(localStorage.getItem(LS_SESSION) || "null"); }
function clearSession(){ localStorage.removeItem(LS_SESSION); }

/* ===============================
   PAGE REFS & HELPERS
   =============================== */
const authShell = document.getElementById("auth-shell");
const appShell = document.getElementById("app-shell");
const menuAdmin = document.getElementById("menu-admin");
const menuStudent = document.getElementById("menu-student");

const pages = {
  admin: document.getElementById("page-admin"),
  adminMarks: document.getElementById("page-admin-marks"),
  adminStudents: document.getElementById("page-admin-students"),
  adminCourses: document.getElementById("page-admin-courses"),
  adminTimetable: document.getElementById("page-admin-timetable"),
  adminAttendance: document.getElementById("page-admin-attendance"),
  adminProfile: document.getElementById("page-admin-profile"),
  // NEW ADMIN PAGES
  adminHostel: document.getElementById("page-admin-hostel"),
  adminFees: document.getElementById("page-admin-fees"),
  adminReval: document.getElementById("page-admin-reval"),
  adminAttReport: document.getElementById("page-admin-att-report"),
  
  student: document.getElementById("page-student"),
  stuMarks: document.getElementById("page-stu-marks"),
  stuAttendance: document.getElementById("page-stu-attendance"),
  stuTimetable: document.getElementById("page-stu-timetable"),
  stuReval: document.getElementById("page-stu-reval"),
  stuProfile: document.getElementById("page-stu-profile"),
  stuFeesMain: document.getElementById("page-stu-fees-main"),
  stuHostelMain: document.getElementById("page-stu-hostel-main")
};

const nestedFeesPages = {
  due: document.getElementById("page-stu-fees-due"),
  pay: document.getElementById("page-stu-fees-pay"),
  history: document.getElementById("page-stu-fees-history")
};
const nestedHostelPages = {
  outing: document.getElementById("page-stu-hostel-outing"),
  issue: document.getElementById("page-stu-hostel-issue")
};

function hideAllPagesInApp(){
  Object.values(pages).forEach(p=>p.classList.add("hidden"));
}

function showPage(pageEl, initialNestedPageId = null){
  if(!pageEl) return;
  hideAllPagesInApp();
  pageEl.classList.remove("hidden");
  window.scrollTo({top:0,behavior:"smooth"});

  // RENDER HOOKS
  const renderMap = {
    [pages.admin.id]: () => { renderAdminDashboard(); updateClassChart(); populateStudentSelect(); renderAdminTables(); renderCourses(); renderTimetable(); renderAttendanceSnapshot(); },
    [pages.adminMarks.id]: populateStudentSelect,
    [pages.adminStudents.id]: renderAdminTables,
    [pages.adminCourses.id]: renderCourses,
    [pages.adminTimetable.id]: renderTimetable,
    [pages.adminAttendance.id]: populateAttendanceStudentList,
    [pages.adminProfile.id]: renderAdminProfile,
    [pages.adminHostel.id]: renderAdminHostelRequests,
    [pages.adminFees.id]: renderAdminFeesManagement,
    [pages.adminReval.id]: renderAdminRevalRequests,
    [pages.adminAttReport.id]: clearAttendanceReport,
    
    [pages.student.id]: renderStudentDashboard,
    [pages.stuMarks.id]: () => { renderStudentDashboard(); renderStudentMarksTable(); },
    [pages.stuAttendance.id]: renderStudentAttendance,
    [pages.stuTimetable.id]: renderStudentTimetable,
    [pages.stuReval.id]: renderStudentRevalList,
    [pages.stuProfile.id]: renderStudentProfile,
    [pages.stuFeesMain.id]: () => { showNestedPage('fees', initialNestedPageId || 'page-stu-fees-due'); renderFeesDue(); renderFeesHistoryTable(); },
    [pages.stuHostelMain.id]: () => { showNestedPage('hostel', initialNestedPageId || 'page-stu-hostel-outing'); renderHostelLists(); }
  };

  const renderFunc = renderMap[pageEl.id];
  if(renderFunc) renderFunc();
}

// Nested Page Helper Function (retained)
function showNestedPage(mainPage, pageId) {
    let menuElement, pagesMap;
    if (mainPage === 'fees') {
        menuElement = document.getElementById('fees-menu');
        pagesMap = nestedFeesPages;
    } else if (mainPage === 'hostel') {
        menuElement = document.getElementById('hostel-menu');
        pagesMap = nestedHostelPages;
    } else {
        return;
    }

    Object.values(pagesMap).forEach(p => p.classList.add('hidden'));
    
    const selectedPage = document.getElementById(pageId);
    if (selectedPage) {
        selectedPage.classList.remove('hidden');
    }

    if (menuElement) {
        menuElement.querySelectorAll('.nested-menu-item').forEach(item => {
            item.classList.remove('active');
            if (item.getAttribute('data-nested-page') === pageId) {
                item.classList.add('active');
            }
        });
    }
}

// Attach listeners for nested menu clicks (retained)
document.querySelectorAll('.nested-page-menu').forEach(menu => {
    menu.addEventListener('click', (e) => {
        const item = e.target.closest('.nested-menu-item');
        if (item) {
            const pageId = item.getAttribute('data-nested-page');
            const mainPage = menu.id.includes('fees') ? 'fees' : 'hostel';
            showNestedPage(mainPage, pageId);
            if (mainPage === 'fees') {
                renderFeesDue();
                renderFeesHistoryTable();
            } else if (mainPage === 'hostel') {
                renderHostelLists();
            }
        }
    });
});

/* ===============================
   Sidebar toggle & menu clicks (retained)
   =============================== */
document.getElementById("sidebar-toggle").onclick = ()=> document.getElementById("sidebar").classList.toggle("collapsed");

document.querySelectorAll('.menu-item').forEach(mi=>{
  mi.addEventListener('click', ()=>{
    const parentMenu = mi.parentElement;
    parentMenu.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
    mi.classList.add('active');
    const page = mi.dataset.page;
    
    const mapping = {};
    Object.keys(pages).forEach(key => {
        mapping[pages[key].id] = pages[key];
    });

    if(mapping[page]) showPage(mapping[page]);
  });
});

/* ===============================
   CAPTCHA FUNCTIONS (retained)
   =============================== */
function randomInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

function generateCaptcha() {
    const num1 = randomInt(1, 10);
    const num2 = randomInt(1, 10);
    const answer = num1 + num2;
    const question = `${num1} + ${num2} = ?`;
    return { question, answer };
}

function renderCaptcha() {
    const captcha = generateCaptcha();
    document.getElementById("captcha-challenge").textContent = captcha.question;
    document.getElementById("captcha-answer").value = "";
    currentCaptchaAnswer = captcha.answer;
}

/* ===============================
   AUTH: login & signup bindings (retained CAPTCHA logic)
   =============================== */
document.getElementById("open-signup").onclick = ()=> { document.getElementById("stu-su-roll").focus(); };
document.getElementById("auth-back").onclick = ()=> window.scrollTo({top:0,behavior:"smooth"});
document.getElementById("auth-back2").onclick = ()=> window.scrollTo({top:0,behavior:"smooth"});
document.getElementById("go-home").onclick = ()=> window.scrollTo({top:0,behavior:"smooth"});

/* create admin */
document.getElementById("admin-create-btn").onclick = ()=>{
  const username = document.getElementById("admin-su-username").value.trim();
  const name = document.getElementById("admin-su-name").value.trim();
  const pass = document.getElementById("admin-su-pass").value;
  const msg = document.getElementById("admin-su-msg");
  if(!username || !name || pass.length < 6){ msg.textContent = "Username, name and password (>=6 chars) required."; return; }
  if(DB.students[username] || DB.admins[username]){ msg.textContent = "This ID/username is already taken."; return; }
  DB.admins[username] = { username, name, password: pass };
  saveDB(DB);
  saveSession({ role:"admin", id: username });
  msg.textContent = "Admin created ‚Äî Redirecting...";
  setTimeout(()=> checkSessionRedirect(), 500);
};

/* create student */
document.getElementById("stu-create-btn").onclick = ()=>{
  const roll = document.getElementById("stu-su-roll").value.trim();
  const name = document.getElementById("stu-su-name").value.trim();
  const cls = document.getElementById("stu-su-class").value.trim();
  const pass = document.getElementById("stu-su-pass").value;
  const msg = document.getElementById("stu-su-msg");
  if(!roll || !name || pass.length < 6){ msg.textContent = "Roll, name and password (>=6 chars) required."; return; }
  if(DB.admins[roll] || DB.students[roll]){ msg.textContent = "This roll number is already registered."; return; }
  DB.students[roll] = { roll, name, cls, password: pass, marks: {}, attendance:{}, revalRequests:[], fees: [], hostel: { outings:[], issues:[] } };
  saveDB(DB);
  saveSession({ role:"student", id: roll });
  msg.textContent = "Student created ‚Äî Redirecting...";
  setTimeout(()=> checkSessionRedirect(), 500);
};

/* login */
document.getElementById("login-btn").onclick = ()=>{
  const role = document.getElementById("login-role").value;
  const id = document.getElementById("login-id").value.trim();
  const pass = document.getElementById("login-pass").value;
  const captchaInput = document.getElementById("captcha-answer").value.trim();
  const msg = document.getElementById("login-msg");
  
  if (!captchaInput || parseInt(captchaInput) !== currentCaptchaAnswer) {
      msg.textContent = "Incorrect security check answer. Please try again.";
      renderCaptcha(); 
      document.getElementById("captcha-answer").focus();
      return;
  }
  
  if(!id || !pass){ msg.textContent="Enter ID and password."; renderCaptcha(); return; }

  if(role === "admin"){
    if(!DB.admins[id]){ msg.textContent="No admin found with this username."; renderCaptcha(); return; }
    if(DB.admins[id].password !== pass){ msg.textContent="Incorrect password."; renderCaptcha(); return; }
    saveSession({ role:"admin", id });
    msg.textContent = "Login success ‚Äî Redirecting...";
    setTimeout(()=> checkSessionRedirect(), 400);
  } else {
    if(!DB.students[id]){ msg.textContent="No student found with this Roll."; renderCaptcha(); return; }
    if(DB.students[id].password !== pass){ msg.textContent="Incorrect password."; renderCaptcha(); return; }
    saveSession({ role:"student", id });
    msg.textContent = "Login success ‚Äî Redirecting...";
    setTimeout(()=> checkSessionRedirect(), 400);
  }
};

/* demo controls */
document.getElementById("demo-load-sample").onclick = loadSampleData;
document.getElementById("demo-clear-local").onclick = clearAllLocal;

/* ===============================
   SESSION: show auth or app (Logout Fix)
   =============================== */
function checkSessionRedirect(){
  const session = loadSession();
  if(!session){
    // LOGOUT STATE
    authShell.classList.remove("hidden");
    appShell.classList.add("hidden");
    menuAdmin.classList.add("hidden");
    menuStudent.classList.add("hidden");
    document.getElementById("current-role-chip").textContent = "Guest";
    document.getElementById("current-user").textContent = "Not signed in";
    window.scrollTo({top:0,behavior:"smooth"});
    renderCaptcha(); 
    return;
  }

  // LOGIN STATE
  appShell.classList.remove("hidden");
  authShell.classList.add("hidden");

  if(session.role === "admin"){
    menuAdmin.classList.remove("hidden");
    menuStudent.classList.add("hidden");
    document.getElementById("current-role-chip").textContent = "Admin";
    document.getElementById("current-user").textContent = DB.admins[session.id] ? `${DB.admins[session.id].name} (${session.id})` : session.id;
    menuAdmin.querySelectorAll('.menu-item').forEach(i=>i.classList.remove('active'));
    menuAdmin.querySelector('.menu-item[data-page="page-admin"]').classList.add('active');
    showPage(pages.admin);
  } else {
    menuStudent.classList.remove("hidden");
    menuAdmin.classList.add("hidden");
    document.getElementById("current-role-chip").textContent = "Student";
    const s = DB.students[session.id];
    document.getElementById("current-user").textContent = s ? `${s.name} ‚Ä¢ ${s.roll}` : session.id;
    menuStudent.querySelectorAll('.menu-item').forEach(i=>i.classList.remove('active'));
    menuStudent.querySelector('.menu-item[data-page="page-student"]').classList.add('active');
    showPage(pages.student);
  }
}

document.getElementById("admin-logout-btn").onclick = ()=>{
  if(confirm("Logout?")){ clearSession(); checkSessionRedirect(); }
};
document.getElementById("stu-logout-btn").onclick = ()=>{
  if(confirm("Logout?")){ clearSession(); checkSessionRedirect(); }
};


/* ===============================
   Demo sample data helpers (Adding Utkarsh Dwivedi - 100)
   =============================== */
function loadSampleData(){
  if(!DB.admins["admin"]){
    DB.admins["admin"] = { username:"admin", name:"Demo Admin", password:"123456" };
  }
  
  // üî•üî•üî• START NEW LINES FOR UTKARSH DWIVEDI (100) üî•üî•üî•
  DB.students["100"] = DB.students["100"] || { 
    roll:"100", name:"Utkarsh Dwivedi", cls:"10-A", password:"student0", 
    marks: { Mathematics:95, Physics:85, Chemistry:75, English:90, Computer:98 }, 
    attendance:{ '2025-11-28': 'present', '2025-11-29': 'present' }, 
    revalRequests: [], 
    fees: [{ id:'F000', type:'Tuition', amount: 20000, date: '2025-11-20', status: 'Paid', method: 'Net Banking', receipt: 'R000' }],
    hostel: { outings:[], issues:[] }
  };
  // üî•üî•üî• END NEW LINES FOR UTKARSH DWIVEDI (100) üî•üî•üî•

  // Sample Data for Rohit Sharma (101)
  DB.students["101"] = DB.students["101"] || { 
    roll:"101", name:"Rohit Sharma", cls:"10-A", password:"student1", 
    marks: { Mathematics:78, Physics:65, Chemistry:72, English:84, Computer:90 }, 
    attendance:{ '2025-11-28': 'present', '2025-11-29': 'absent' }, 
    revalRequests: [
        { id: 'R901', subject: 'Physics', reason: 'Felt I deserve 80', status: 'Pending', date: '2025-11-20', initialMark: 65 }
    ], 
    fees: [
        { id:'F001', type:'Tuition', amount: 15000, date: '2025-06-01', status: 'Paid', method: 'UPI', receipt: 'R001' }
    ],
    hostel: { 
        outings:[{ id:'O001', dest:'Home', reason:'Family visit', returnDate:'2025-12-05', status:'Pending', date:'2025-11-29'}], 
        issues:[{ id:'I001', location:'Room 302', desc:'AC not cooling', status:'Open', date:'2025-11-27' }] 
    }
  };
  // Sample Data for Sneha Verma (102)
  DB.students["102"] = DB.students["102"] || { 
    roll:"102", name:"Sneha Verma", cls:"10-A", password:"student2", 
    marks: { Mathematics:88, Physics:75, Chemistry:68, English:92, Computer:85 }, 
    attendance:{ '2025-11-28': 'present', '2025-11-29': 'present' }, 
    revalRequests:[],
    fees: [
        { id:'F002', type:'Hostel', amount: 5000, date: null, status: 'Due', dueDate: '2025-12-15' }
    ],
    hostel: { outings:[], issues:[] }
  };
  DB.students["103"] = DB.students["103"] || { 
    roll:"103", name:"Aman Patel", cls:"10-B", password:"student3", 
    marks: { Mathematics:55, Physics:45, Chemistry:50, English:60, Computer:58 }, 
    attendance:{ '2025-11-28': 'absent', '2025-11-29': 'absent' },
    revalRequests:[], 
    fees: [], 
    hostel: { outings:[], issues:[] } 
  };
  
  DB.attendance['2025-11-29_10-A'] = { '101': 'absent', '102': 'present' };
  
  DB.courses["MATH101"] = DB.courses["MATH101"] || { code:"MATH101", title:"Mathematics" };
  DB.courses["PHY101"] = DB.courses["PHY101"] || { code:"PHY101", title:"Physics" };
  DB.timetable["Monday"] = DB.timetable["Monday"] || [{slot:"10:00 - 11:00", sub:"Mathematics"},{slot:"11:15 - 12:15", sub:"Physics"}];
  saveDB(DB);
  alert("Sample data loaded.\nAdmin: username=admin, password=123456.\n\nNEW TEST USER: Utkarsh Dwivedi (Roll 100, Pass student0).\n\nOther Students: 101/102/103 passwords student1/2/3");
  checkSessionRedirect();
  renderAdminTables(); updateClassChart(); renderCourses(); renderTimetable();
}

function clearAllLocal(){
  if(confirm("Clear all local data (including accounts)?")){
    DB = { admins:{}, students:{}, courses:{}, timetable:{}, attendance:{} };
    saveDB(DB); clearSession(); checkSessionRedirect(); alert("Cleared");
  }
}

/* ===============================
   ADMIN: Students & Marks CRUD (with Search Filter)
   =============================== */
const selStudent = document.getElementById("sel-student");
function populateStudentSelect(){
  const students = Object.values(DB.students).sort((a,b)=> a.roll.localeCompare(b.roll));
  
  [document.getElementById("sel-student"), document.getElementById("admin-fee-stu")].forEach(selectEl => {
      if(!selectEl) return;
      selectEl.innerHTML = "";
      students.forEach(s => {
          const opt = document.createElement("option");
          opt.value = s.roll; opt.textContent = s.roll + " - " + s.name;
          selectEl.appendChild(opt);
      });
  });
  renderAdminTables();
}

document.getElementById("add-student").onclick = ()=>{
  const roll = document.getElementById("s-roll").value.trim();
  const name = document.getElementById("s-name").value.trim();
  const cls = document.getElementById("s-class").value.trim();
  const msg = document.getElementById("student-msg");
  if(!roll || !name){ msg.textContent = "Roll and Name are required."; return; }
  if(DB.students[roll] || DB.admins[roll]){ msg.textContent = "This ID already exists."; return; }
  DB.students[roll] = { roll, name, cls, password: "changeme", marks: {}, attendance:{}, revalRequests:[], fees: [], hostel: { outings:[], issues:[] } };
  saveDB(DB);
  msg.textContent = "Student added. Default password: changeme";
  document.getElementById("s-roll").value=""; document.getElementById("s-name").value=""; document.getElementById("s-class").value="";
  populateStudentSelect(); renderAdminTables();
  setTimeout(()=> msg.textContent="",2000);
};

document.getElementById("save-marks").onclick = ()=>{
  const roll = selStudent ? selStudent.value : null;
  const subj = document.getElementById("subj").value;
  const marks = parseFloat(document.getElementById("marks").value);
  const msg = document.getElementById("marks-msg");
  if(!roll){ msg.textContent = "Select a student."; return; }
  if(isNaN(marks) || marks<0 || marks>100){ msg.textContent = "Enter marks between 0 and 100."; return; }
  DB.students[roll].marks[subj] = marks;
  saveDB(DB);
  msg.textContent = `Saved ${subj}: ${marks} for ${roll}`;
  updateClassChart(); renderAdminTables();
  setTimeout(()=> msg.textContent="",1400);
};

document.getElementById("admin-sample").onclick = ()=>{
  const roll = selStudent ? selStudent.value : null;
  if(!roll){ alert("Select student first"); return; }
  const marks = { Mathematics: randomInt(40,95), Physics: randomInt(40,95), Chemistry: randomInt(40,95), English: randomInt(40,95), Computer: randomInt(40,95) };
  DB.students[roll].marks = Object.assign({}, DB.students[roll].marks || {}, marks);
  saveDB(DB); updateClassChart(); renderAdminTables(); alert("Sample marks added for " + roll);
};

document.getElementById("admin-sample-fill").onclick = ()=> {
  Object.keys(DB.students).forEach(r=>{
    DB.students[r].marks = { Mathematics: randomInt(40,95), Physics: randomInt(40,95), Chemistry: randomInt(40,95), English: randomInt(40,95), Computer: randomInt(40,95) };
  });
  saveDB(DB); updateClassChart(); renderAdminTables(); alert("Sample marks filled for all students.");
};

const studentsTableBody = document.querySelector("#students-table tbody");
function renderAdminTables(){
  const searchTerm = document.getElementById('student-search-input')?.value?.toLowerCase() || '';
  const studentsSorted = Object.values(DB.students)
    .filter(s => 
        s.roll.toLowerCase().includes(searchTerm) || 
        s.name.toLowerCase().includes(searchTerm)
    )
    .sort((a,b)=> a.roll.localeCompare(b.roll));
  
  let tableHTML = '';

  studentsSorted.forEach(s=>{
    const avg = averageObjectValues(s.marks);
    tableHTML += `<tr><td>${s.roll}</td><td>${s.name}</td><td>${s.cls||""}</td><td>${isNaN(avg) ? "-" : avg.toFixed(1)}</td>
      <td>
        <button class="btn" data-roll="${s.roll}" onclick="showStudentSummary('${s.roll}')" style="padding:6px 8px">View</button>
        <button class="btn btn-outline" data-del="${s.roll}" onclick="deleteStudent('${s.roll}')" style="padding:6px 8px">Delete</button>
      </td></tr>`;
  });
  
  if (studentsTableBody) studentsTableBody.innerHTML = tableHTML;
  document.getElementById("students-count").textContent = Object.values(DB.students).length;
}

function deleteStudent(roll){
    if(confirm("Delete student " + roll + "?")){
        delete DB.students[roll]; 
        saveDB(DB); 
        populateStudentSelect(); 
        renderAdminTables(); 
        updateClassChart();
        alert(`Student ${roll} deleted.`);
    }
}

function averageObjectValues(obj){
  const vals = Object.values(obj||{});
  if(vals.length === 0) return NaN;
  return vals.reduce((a,b)=>a+b,0)/vals.length;
}

function showStudentSummary(roll){
  const s = DB.students[roll];
  if(!s) return;
  alert(`${s.name} (${s.roll}) ‚Äî Marks: ${JSON.stringify(s.marks || {})}`);
}

/* ===============================
   ADMIN: ATTENDANCE REPORT (NEW FEATURE)
   =============================== */
function clearAttendanceReport() {
    document.getElementById('report-class').value = '';
    document.getElementById('report-date').value = '';
    document.getElementById('att-report-results').innerHTML = 'No report generated. Use filters above.';
    document.getElementById('att-report-msg').textContent = '';
}

document.getElementById('clear-att-report').onclick = clearAttendanceReport;

document.getElementById('generate-att-report').onclick = () => {
    const filterClass = document.getElementById('report-class').value.trim().toLowerCase();
    const filterDate = document.getElementById('report-date').value;
    const resultsEl = document.getElementById('att-report-results');
    const msgEl = document.getElementById('att-report-msg');
    
    msgEl.textContent = '';
    
    // 1. Identify relevant attendance records (dates/classes)
    let records = Object.keys(DB.attendance).filter(key => {
        const [date, cls] = key.split('_');
        const matchesClass = !filterClass || cls.toLowerCase() === filterClass;
        const matchesDate = !filterDate || date === filterDate;
        return matchesClass && matchesDate;
    }).sort();

    if (records.length === 0) {
        resultsEl.innerHTML = `No attendance records found for the given criteria.`;
        return;
    }

    // 2. Identify all unique students who have records in these dates/classes
    let studentRolls = new Set();
    records.forEach(key => {
        Object.keys(DB.attendance[key]).forEach(roll => studentRolls.add(roll));
    });

    const students = Array.from(studentRolls).map(roll => DB.students[roll]).filter(s => s);

    // 3. Build the table headers
    let tableHTML = `<table class="attendance-report-table">
        <thead><tr><th>Roll / Name</th><th>Class</th>`;
    records.forEach(key => {
        const [date, cls] = key.split('_');
        tableHTML += `<th>${date}<br>(${cls})</th>`;
    });
    tableHTML += `<th>Total P/A</th></tr></thead><tbody>`;

    // 4. Populate table rows
    students.forEach(s => {
        let totalPresent = 0;
        let totalAbsent = 0;
        
        tableHTML += `<tr><td>${s.roll} - ${s.name}</td><td>${s.cls}</td>`;

        records.forEach(key => {
            const status = DB.attendance[key][s.roll];
            let cellContent = '-';
            if (status) {
                if (status === 'present') {
                    cellContent = `<span style="color:${getComputedStyle(document.documentElement).getPropertyValue('--success')}">P</span>`;
                    totalPresent++;
                } else if (status === 'absent') {
                    cellContent = `<span style="color:#b91c1c">A</span>`;
                    totalAbsent++;
                }
            }
            tableHTML += `<td>${cellContent}</td>`;
        });

        tableHTML += `<td>${totalPresent} P / ${totalAbsent} A</td></tr>`;
    });

    tableHTML += `</tbody></table>`;
    resultsEl.innerHTML = tableHTML;
    msgEl.textContent = `Found ${students.length} students and ${records.length} total attendance sessions matching the criteria.`;
};


/* ===============================
   THEME SWITCHING (Updated)
   =============================== */
document.getElementById("theme-picker").onchange = function(){
  const v = this.value;
  document.body.className = '';
  document.body.style.background = "var(--bg)";

  if(v==="dark") {
    document.body.style.background = "linear-gradient(180deg,#071021,#0b1220)";
  }
  document.body.classList.add(`theme-${v}`);
};

/* ===============================
   HOSTEL MANAGEMENT (Student/Admin)
   =============================== */
function getStuHostelData(session) {
    if (!session || session.role !== "student" || !DB.students[session.id]) return null;
    let s = DB.students[session.id];
    if (!s.hostel) s.hostel = { outings:[], issues:[] };
    return s.hostel;
}

function renderHostelLists() { // Student View
    const session = loadSession();
    const hostelData = getStuHostelData(session);
    if (!hostelData) return;

    const renderList = (data, elId, mapFunc) => {
        const el = document.getElementById(elId);
        if (!el) return;
        el.innerHTML = data.length === 0 ? "No requests found." : data.map(mapFunc).join('');
    };

    renderList(hostelData.outings.sort((a,b) => b.date.localeCompare(a.date)), 'outing-list', o => 
        `<div><strong>${o.dest}</strong> <span class="action-badge status-${o.status}">${o.status}</span> ‚Äî Return: ${o.returnDate} <div class="small-muted">Reason: ${o.reason}</div></div>`
    );

    renderList(hostelData.issues.sort((a,b) => b.date.localeCompare(a.date)), 'issue-list', i => 
        `<div><strong>${i.location}</strong> <span class="action-badge status-${i.status}">${i.status}</span> ‚Äî ${i.desc} <div class="small-muted">Reported: ${i.date}</div></div>`
    );
}

// Student Submit Handlers (retained)
document.getElementById('submit-outing').onclick = () => {
    const session = loadSession();
    const s = DB.students[session.id];
    const dest = document.getElementById('outing-dest').value.trim();
    const reason = document.getElementById('outing-reason').value.trim();
    const returnDate = document.getElementById('outing-return-date').value;
    const msgEl = document.getElementById('outing-msg');
    if (!dest || !reason || !returnDate) { msgEl.textContent = "All fields required."; return; }

    s.hostel.outings.push({ id: `O${Date.now()}`, dest, reason, returnDate, status: 'Pending', date: new Date().toISOString().slice(0,10) });
    saveDB(DB);
    msgEl.textContent = "Outing request submitted. Status: Pending.";
    document.getElementById('outing-dest').value = document.getElementById('outing-reason').value = document.getElementById('outing-return-date').value = "";
    renderHostelLists();
    setTimeout(() => msgEl.textContent = "", 2000);
};

document.getElementById('submit-issue').onclick = () => {
    const session = loadSession();
    const s = DB.students[session.id];
    const location = document.getElementById('issue-location').value.trim();
    const desc = document.getElementById('issue-desc').value.trim();
    const msgEl = document.getElementById('issue-msg');
    if (!location || !desc) { msgEl.textContent = "Location and description required."; return; }

    s.hostel.issues.push({ id: `I${Date.now()}`, location, desc, status: 'Open', date: new Date().toISOString().slice(0,10) });
    saveDB(DB);
    msgEl.textContent = "Issue reported. Status: Open.";
    document.getElementById('issue-location').value = document.getElementById('issue-desc').value = "";
    renderHostelLists();
    setTimeout(() => msgEl.textContent = "", 2000);
};

// Admin View/Action (retained)
function renderAdminHostelRequests() {
    let outingHTML = '';
    let issueHTML = '';

    Object.values(DB.students).forEach(s => {
        (s.hostel?.outings || []).filter(o => o.status === 'Pending').forEach(o => {
            outingHTML += `<div class="card small-muted" style="padding:10px; margin-bottom:5px;">
                <strong>${s.roll} - ${s.name}:</strong> To ${o.dest} (Return: ${o.returnDate})<br>
                Reason: ${o.reason}
                <div style="margin-top:5px;">
                    <button class="btn" style="padding:5px 10px; background:var(--success)" onclick="updateHostelStatus('${s.roll}', 'outing', '${o.id}', 'Approved')">Approve</button>
                    <button class="btn btn-outline" style="padding:5px 10px; color:#b91c1c" onclick="updateHostelStatus('${s.roll}', 'outing', '${o.id}', 'Rejected')">Deny</button>
                </div>
            </div>`;
        });

        (s.hostel?.issues || []).filter(i => i.status === 'Open').forEach(i => {
            issueHTML += `<div class="card small-muted" style="padding:10px; margin-bottom:5px;">
                <strong>${s.roll} - ${s.name}:</strong> ${i.location} ‚Äî ${i.desc}<br>
                Reported: ${i.date}
                <div style="margin-top:5px;">
                    <button class="btn" style="padding:5px 10px; background:#4b5563" onclick="updateHostelStatus('${s.roll}', 'issue', '${i.id}', 'Closed')">Mark Closed</button>
                </div>
            </div>`;
        });
    });

    document.getElementById('admin-outing-requests').innerHTML = outingHTML || 'No pending requests.';
    document.getElementById('admin-issue-requests').innerHTML = issueHTML || 'No open issues.';
}

function updateHostelStatus(roll, type, id, status) {
    const s = DB.students[roll];
    if (!s) return;

    if (type === 'outing') {
        const req = s.hostel.outings.find(o => o.id === id);
        if (req) {
            req.status = status;
            saveDB(DB);
            renderAdminHostelRequests();
            alert(`Outing for ${s.name} ${status}.`);
        }
    } else if (type === 'issue') {
        const req = s.hostel.issues.find(i => i.id === id);
        if (req) {
            req.status = status;
            saveDB(DB);
            renderAdminHostelRequests();
            alert(`Issue for ${s.name} ${status}.`);
        }
    }
}


/* ===============================
   FEES MANAGEMENT (Student/Admin)
   =============================== */
function getStuFeesData(session) {
    if (!session || session.role !== "student" || !DB.students[session.id]) return null;
    let s = DB.students[session.id];
    if (!s.fees) s.fees = [];
    return s.fees;
}

function renderFeesDue() {
    const session = loadSession();
    const fees = getStuFeesData(session);
    if (!fees) return;

    const dueFees = fees.filter(f => f.status === 'Due');
    const totalDue = dueFees.reduce((sum, f) => sum + f.amount, 0);
    const earliestDueDate = dueFees.length ? 
        dueFees.sort((a, b) => (a.dueDate || '9999-12-31').localeCompare(b.dueDate || '9999-12-31'))[0].dueDate : 'N/A';

    document.getElementById('fees-due-amount').textContent = totalDue.toFixed(2);
    document.getElementById('fees-due-date').textContent = earliestDueDate;
    document.getElementById('fee-amount').value = totalDue > 0 ? totalDue : 15000;
}

function renderFeesHistoryTable() {
    const session = loadSession();
    const fees = getStuFeesData(session);
    if (!fees) return;

    const tbody = document.querySelector('#fees-history-table tbody');
    const noneMsg = document.getElementById('fees-history-none');
    
    const paidFees = fees.filter(f => f.status === 'Paid').sort((a,b) => b.date.localeCompare(a.date));
    
    if (paidFees.length === 0) {
        tbody.innerHTML = '';
        noneMsg.classList.remove('hidden');
        return;
    }
    noneMsg.classList.add('hidden');

    const tableHTML = paidFees.map(f => `
        <tr>
            <td>${f.date}</td>
            <td>‚Çπ ${f.amount.toFixed(2)}</td>
            <td><span class="action-badge status-Paid">${f.status}</span></td>
            <td><button class="link-btn" onclick="generateReceipt('${f.id}')">View/Print</button></td>
        </tr>
    `).join('');
    
    tbody.innerHTML = tableHTML;
}

// Student Payment Handler (retained)
document.getElementById('fees-pay-quick').onclick = () => { showNestedPage('fees', 'page-stu-fees-pay'); }

document.getElementById('submit-fee-payment').onclick = () => {
    const session = loadSession();
    const s = DB.students[session.id];
    const amount = parseFloat(document.getElementById('fee-amount').value);
    const method = document.getElementById('fee-method').value;
    const msgEl = document.getElementById('fees-pay-msg');

    if (isNaN(amount) || amount <= 0) { msgEl.textContent = "Please enter a valid amount."; return; }
    
    let remainingAmount = amount;
    const today = new Date().toISOString().slice(0,10);
    let receiptId = `R${Date.now()}`;

    // Update dues (mark as paid)
    s.fees.forEach(f => {
        if (f.status === 'Due' && remainingAmount >= f.amount) {
            f.status = 'Paid';
            f.date = today;
            f.method = method;
            f.receipt = receiptId;
            remainingAmount -= f.amount;
        }
    });

    // If remaining amount is still > 0, assume it covers new/generic fees
    if (remainingAmount > 0) {
        s.fees.push({
            id: `F${Date.now()}`,
            type: 'Generic',
            amount: remainingAmount,
            date: today,
            status: 'Paid',
            method: method,
            receipt: receiptId,
        });
    }

    saveDB(DB);

    msgEl.textContent = `Payment of ‚Çπ ${amount.toFixed(2)} successful via ${method}. Receipt ID: ${receiptId}`;
    renderFeesDue();
    renderFeesHistoryTable();
    showNestedPage('fees', 'page-stu-fees-history');
    setTimeout(() => msgEl.textContent = "", 3000);
};

// Admin View/Action (retained)
function renderAdminFeesManagement() {
    populateStudentSelect();

    let duesHTML = `
        <table style="width:100%">
            <thead><tr><th>Roll</th><th>Name</th><th>Type</th><th>Amount</th><th>Due Date</th></tr></thead>
            <tbody>
    `;
    let hasDues = false;

    Object.values(DB.students).forEach(s => {
        (s.fees || []).filter(f => f.status === 'Due').forEach(f => {
            duesHTML += `<tr>
                <td>${s.roll}</td>
                <td>${s.name}</td>
                <td>${f.type}</td>
                <td>‚Çπ ${f.amount.toFixed(2)}</td>
                <td>${f.dueDate}</td>
            </tr>`;
            hasDues = true;
        });
    });

    duesHTML += `</tbody></table>`;
    document.getElementById('admin-all-dues').innerHTML = hasDues ? duesHTML : 'No pending dues across all students.';
}

document.getElementById('admin-add-due').onclick = () => {
    const roll = document.getElementById("admin-fee-stu").value;
    const type = document.getElementById("admin-fee-type").value.trim();
    const amount = parseFloat(document.getElementById("admin-fee-amount").value);
    const dueDate = document.getElementById("admin-fee-due-date").value;
    const msgEl = document.getElementById("admin-fee-msg");

    if (!roll || !type || isNaN(amount) || amount <= 0 || !dueDate) {
        msgEl.textContent = "Please fill all fields correctly.";
        return;
    }

    const s = DB.students[roll];
    if (!s) return;
    
    s.fees.push({
        id: `F${Date.now()}`,
        type: type,
        amount: amount,
        date: null,
        status: 'Due',
        dueDate: dueDate
    });
    saveDB(DB);
    msgEl.textContent = `Added ‚Çπ ${amount.toFixed(2)} ${type} due for ${s.name}.`;
    renderAdminFeesManagement();
    setTimeout(() => msgEl.textContent = "", 2000);
};

/* ===============================
   REVALUATION (Student/Admin)
   =============================== */

// Student Submit Handler (retained)
document.getElementById("submit-reval").onclick = ()=>{
  const session = loadSession(); if(!session || session.role!=="student"){ alert("Login as student to apply."); return; }
  const sroll = session.id;
  const sub = document.getElementById("reval-sub").value;
  const reason = document.getElementById("reval-reason").value.trim();
  if(!reason){ document.getElementById("reval-msg").textContent = "Provide a reason."; return; }

  const req = { id: `R${Date.now()}`, roll: sroll, subject: sub, reason, status: "Pending", date: new Date().toISOString().slice(0,10), initialMark: DB.students[sroll].marks[sub] || 0 };
  DB.students[sroll].revalRequests = DB.students[sroll].revalRequests || [];
  DB.students[sroll].revalRequests.push(req);
  saveDB(DB);
  document.getElementById("reval-msg").textContent = "Request submitted. Status: Pending.";
  document.getElementById("reval-reason").value = "";
  renderStudentRevalList();
  setTimeout(()=> document.getElementById("reval-msg").textContent = "",1400);
};

function renderStudentRevalList(){ // Student View (retained)
  const session = loadSession(); if(!session || session.role!=="student") return;
  const s = DB.students[session.id];
  const el = document.getElementById("reval-list"); el.innerHTML = "";
  const arr = s.revalRequests || [];
  if(arr.length===0){ el.textContent = "No requests yet."; return; }
  
  const revalHTML = arr.map(r => `
    <div><strong>${r.subject}</strong> <span class="action-badge status-${r.status}">${r.status}</span> (${r.date})
    <div class="small-muted">Reason: ${r.reason} (Initial Mark: ${r.initialMark})</div></div>
  `).join('');
  el.innerHTML = revalHTML;
}

// Admin View/Action (retained)
function renderAdminRevalRequests() {
    document.getElementById('admin-reval-action').classList.add('hidden');
    let revalHTML = '';

    Object.values(DB.students).forEach(s => {
        (s.revalRequests || []).filter(r => r.status === 'Pending').forEach(r => {
            revalHTML += `<div class="card small-muted" style="padding:10px; margin-bottom:5px;">
                <strong>${s.roll} - ${s.name}:</strong> ${r.subject} (Current Mark: ${r.initialMark})<br>
                Reason: ${r.reason}
                <div style="margin-top:5px;">
                    <button class="btn" style="padding:5px 10px; background:var(--success)" onclick="approveReval('${s.roll}', '${r.id}')">Approve</button>
                    <button class="btn btn-outline" style="padding:5px 10px; color:#b91c1c" onclick="rejectReval('${s.roll}', '${r.id}')">Reject</button>
                </div>
            </div>`;
        });
    });

    document.getElementById('admin-reval-requests').innerHTML = revalHTML || 'No pending re-evaluation requests.';
}

function findRevalRequest(roll, id) {
    const s = DB.students[roll];
    return s ? s.revalRequests.find(r => r.id === id) : null;
}

function approveReval(roll, id) {
    const req = findRevalRequest(roll, id);
    if (!req) return;
    req.status = 'Approved';
    saveDB(DB);

    document.getElementById('reval-update-roll').value = roll;
    document.getElementById('reval-update-subj').value = req.subject;
    document.getElementById('reval-update-mark').value = req.initialMark;
    document.getElementById('admin-reval-action').classList.remove('hidden');
    renderAdminRevalRequests();
}

function rejectReval(roll, id) {
    const req = findRevalRequest(roll, id);
    if (!req) return;
    req.status = 'Rejected';
    saveDB(DB);
    renderAdminRevalRequests();
    alert(`Re-evaluation for ${DB.students[roll].name} (${req.subject}) rejected.`);
}

document.getElementById('reval-final-save').onclick = () => {
    const roll = document.getElementById('reval-update-roll').value;
    const subj = document.getElementById('reval-update-subj').value;
    const newMark = parseFloat(document.getElementById('reval-update-mark').value);
    const msgEl = document.getElementById('reval-update-msg');

    if (isNaN(newMark) || newMark < 0 || newMark > 100) {
        msgEl.textContent = "Please enter a valid mark (0-100).";
        return;
    }

    const s = DB.students[roll];
    s.revalRequests = s.revalRequests.filter(r => !(r.roll === roll && r.subject === subj && r.status === 'Approved'));
    
    s.marks[subj] = newMark;
    saveDB(DB);
    
    msgEl.textContent = `Mark for ${s.name} in ${subj} updated to ${newMark}.`;
    document.getElementById('admin-reval-action').classList.add('hidden');
    updateClassChart();
    renderAdminTables();
    renderAdminRevalRequests();
};


/* ===============================
   OTHER ADMIN FUNCTIONS (RETAINED)
   =============================== */

function renderAdminDashboard(){ /* Admin Welcome message update */ }
function renderStudentDashboard(){ /* Student Welcome & Suggestions update */ }
function renderStudentMarksTable(){ /* Student Marks Table render */ }
async function exportStudentPDF(roll){ /* Student PDF export */ }
document.getElementById("stu-download").onclick = ()=>{ const session = loadSession(); if(!session || session.role!=="student") return alert("Login as student"); exportStudentPDF(session.id); };
document.getElementById("stu-apply-reval").onclick = ()=>{ showPage(pages.stuReval); };
function renderCourses(){ /* Courses List render */ }
document.getElementById("add-course").onclick = ()=>{ /* Add Course logic */ };
document.getElementById("clear-courses").onclick = ()=>{ /* Clear Courses logic */ };
document.getElementById("add-tt").onclick = ()=>{ /* Add Timetable Slot logic */ };
document.getElementById("clear-tt").onclick = ()=>{ /* Clear Timetable logic */ };
function renderTimetable(){ /* Render Timetable List */ }
function renderTodayTimetable(){ /* Render Admin Today's Timetable */ }
function renderStudentTimetable(){ /* Render Student Timetable */ }
function populateAttendanceStudentList(){ /* Populate checkboxes for attendance */ }
document.getElementById("save-attendance").onclick = ()=>{ /* Save Attendance logic */ };
document.getElementById("view-attendance").onclick = ()=>{ /* View Attendance logic */ };
function renderStudentAttendance(){ /* Render Student Attendance list */ }
function renderAttendanceSnapshot(){ /* Render Admin Attendance Snapshot */ }
function renderAdminProfile(){ /* Render Admin Profile */ }
function renderStudentProfile(){ /* Render Student Profile */ }
document.getElementById("admin-action-export").onclick = ()=>{ /* Export Class PDF */ };

// Charts (Retained)
let classBarChart = null;
function updateClassChart(){
  const subjTotals = {};
  const subjCounts = {};
  Object.values(DB.students).forEach(s=>{
    Object.entries(s.marks||{}).forEach(([sub, score])=>{
      subjTotals[sub] = (subjTotals[sub] || 0) + score;
      subjCounts[sub] = (subjCounts[sub] || 0) + 1;
    });
  });
  const subjects = Object.keys(subjTotals);
  const avgs = subjects.map(s=> Math.round((subjTotals[s]/subjCounts[s]) * 10)/10 );

  const ctx = document.getElementById("class-bar").getContext("2d");
  if(classBarChart) classBarChart.destroy();
  classBarChart = new Chart(ctx, {
    type: 'bar',
    data: { labels: subjects.length ? subjects : ["No Data"], datasets:[{ label:'Average Marks', data: subjects.length ? avgs : [0], backgroundColor: 'rgba(11,93,215,0.85)'}] },
    options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, max:100 } } }
  });
}
let stuBar=null;
function renderStudentCharts(labels, data){
  const ctx1 = document.getElementById("stu-bar").getContext("2d");
  if(stuBar) stuBar.destroy();
  stuBar = new Chart(ctx1, { type:'bar', data:{ labels, datasets:[{label:'Marks', data}] }, options:{responsive:true, maintainAspectRatio:false, scales:{ y:{beginAtZero:true,max:100}} }});
}


/* ===============================
   INITIAL RENDERS
   =============================== */
document.getElementById("login-id").addEventListener("keydown", e=>{ if(e.key==='Enter') document.getElementById("login-btn").click(); });
document.getElementById("login-pass").addEventListener("keydown", e=>{ if(e.key==='Enter') document.getElementById("login-btn").click(); });
document.getElementById("captcha-answer").addEventListener("keydown", e=>{ if(e.key==='Enter') document.getElementById("login-btn").click(); });

checkSessionRedirect(); 
</script>
</body>
</html>